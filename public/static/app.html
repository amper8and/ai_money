<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UBA â€” AI-Money Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        uba: { red: '#E4002B', 'red-dark': '#C00024' },
                        emerald: { DEFAULT: '#10b981', dark: '#059669' },
                        gold: { DEFAULT: '#f59e0b', dark: '#d97706' }
                    },
                    fontFamily: { sans: ['Montserrat', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Montserrat', sans-serif;
            background: #0a0a0a;
            color: #fff;
            -webkit-font-smoothing: antialiased;
        }
        .card { background: #212121; border-radius: 1rem; padding: 1.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card:hover { background: #2a2a2a; cursor: pointer; }
        .card-static { background: #212121; border-radius: 1rem; padding: 1.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .btn {
            padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 500;
            transition: all 0.2s; cursor: pointer; border: none;
            display: inline-flex; align-items: center; gap: 0.5rem;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: #10b981; color: white; }
        .btn-primary:hover { background: #059669; }
        .btn-outline { background: transparent; color: #10b981; border: 1.5px solid #10b981; }
        .btn-outline:hover { background: rgba(16,185,129,0.1); }
        .progress-bar { width: 100%; height: 0.5rem; background: #1a1a1a; border-radius: 9999px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #10b981, #34d399); transition: width 0.5s; }
        .badge { display: inline-flex; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-warning { background: rgba(245,158,11,0.2); color: #f59e0b; }
        .badge-success { background: rgba(16,185,129,0.2); color: #10b981; }
        .badge-blue { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .toast {
            position: fixed; bottom: 5rem; left: 1rem; right: 1rem;
            background: #212121; color: white; padding: 1rem; border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.4); z-index: 100;
            animation: slideUp 0.3s; border-left: 4px solid #10b981;
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* â”€â”€ CHAT STYLES â”€â”€ */
        .chat-wrap {
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
            background: #0a0a0a;
        }
        .chat-header {
            flex-shrink: 0;
            padding: 0.875rem 1.25rem;
            background: #111;
            border-bottom: 1px solid #222;
            display: flex; align-items: center; gap: 0.75rem;
        }
        .chat-messages {
            flex: 1; overflow-y: auto;
            padding: 1rem 1rem 0.5rem;
            display: flex; flex-direction: column; gap: 0.75rem;
            scroll-behavior: smooth;
        }
        .chat-messages::-webkit-scrollbar { width: 0; }
        .msg-row { display: flex; align-items: flex-end; gap: 0.5rem; }
        .msg-row.user { flex-direction: row-reverse; }
        .msg-avatar {
            width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem;
        }
        .bubble {
            max-width: 78%; padding: 0.7rem 0.9rem;
            border-radius: 1.1rem; font-size: 0.875rem; line-height: 1.45;
        }
        .bubble.ai {
            background: #1e1e1e; color: #eee;
            border-bottom-left-radius: 0.25rem;
            border: 1px solid #2a2a2a;
        }
        .bubble.user {
            background: #E41000; color: #fff;
            border-bottom-right-radius: 0.25rem;
        }
        .typing-bubble {
            background: #1e1e1e; border: 1px solid #2a2a2a;
            padding: 0.7rem 1rem; border-radius: 1.1rem;
            border-bottom-left-radius: 0.25rem;
            display: inline-flex; align-items: center; gap: 4px;
        }
        .typing-dot {
            width: 7px; height: 7px; border-radius: 50%;
            background: #555; animation: typingBounce 1.2s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); background: #555; }
            30% { transform: translateY(-5px); background: #10b981; }
        }
        .plan-card {
            border: 2px solid #333; border-radius: 1rem; padding: 1.1rem;
            background: #1a1a1a; cursor: pointer; transition: all 0.2s; margin-bottom: 0.6rem;
        }
        .plan-card:hover { border-color: #555; background: #212121; }
        .plan-card.selected { border-color: #10b981; background: rgba(16,185,129,0.08); }
        .plan-card.recommended { border-color: rgba(245,158,11,0.55); }
        .shortcut-btn {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.5rem 0.9rem; border-radius: 9999px; font-size: 0.78rem; font-weight: 500;
            border: 1.5px solid #333; background: #161616; color: #bbb;
            cursor: pointer; transition: all 0.18s; white-space: nowrap;
        }
        .shortcut-btn:hover { border-color: #E41000; color: #fff; background: rgba(228,0,43,0.1); }
        .shortcut-btn:active { transform: scale(0.95); }
        .chat-input-area {
            flex-shrink: 0;
            padding: 0.75rem 1rem 1rem;
            background: #111;
            border-top: 1px solid #1e1e1e;
        }
        .shortcuts-row {
            display: flex; gap: 0.5rem; overflow-x: auto;
            padding-bottom: 0.6rem; margin-bottom: 0.5rem;
        }
        .shortcuts-row::-webkit-scrollbar { height: 0; }
        .chat-input-row {
            display: flex; align-items: center; gap: 0.5rem;
            background: #1a1a1a; border-radius: 0.875rem;
            border: 1.5px solid #2a2a2a; padding: 0.4rem 0.4rem 0.4rem 1rem;
        }
        .chat-input-row:focus-within { border-color: #E41000; }
        #chat-input {
            flex: 1; background: transparent; border: none; outline: none;
            color: #fff; font-size: 0.875rem; font-family: 'Montserrat', sans-serif;
            resize: none; max-height: 80px; overflow-y: auto; line-height: 1.4;
        }
        #chat-input::placeholder { color: #444; }
        .send-btn {
            width: 36px; height: 36px; border-radius: 0.625rem; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            background: #E41000; border: none; cursor: pointer; transition: all 0.15s;
        }
        .send-btn:hover { background: #c00020; }
        .send-btn:active { transform: scale(0.92); }
        .hidden { display: none; }
    </style>
</head>
<body>
<div id="app"></div>
<script>

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var state = {
    isAuth: false,
    page: 'welcome',
    goal: null,
    selectedPlan: null,
    chat: {
        messages: [],        // { role:'ai'|'user', text, cards, planCards, actionBtn }
        collecting: null,    // which field we're waiting for
        isTyping: false
    },
    user: {
        name: 'Amina Diallo',
        phone: '+234 *** **7',
        email: 'a.diallo@email.com',
        badges: ['Goal Setter', 'AutoSave Enabled', 'Early Adopter'],
        wallet: { cash: 2500, points: 150 }
    },
    missions: [{
        id: 'mission-home-upgrade',
        name: 'Home Upgrade Sprint',
        desc: 'Fund your renovation without financial stress',
        reward: '250 Goal Points',
        progress: 1,
        total: 3,
        steps: [
            { id: 's1', text: 'Create Renovation Goal', done: true },
            { id: 's2', text: 'Open Renovation Pocket + Activate AutoSave', done: false },
            { id: 's3', text: 'Accept Pre-Approval + Choose payout option', done: false }
        ]
    }],
    rewards: [
        { id: 1, amount: '&#8358;500 Cashback', source: 'Partner Merchant', status: 'redeem', statusColor: '#E41000' },
        { id: 2, amount: '250 Goal Points', source: 'Home Upgrade Sprint', status: 'pending', statusColor: '#666' },
        { id: 3, amount: 'Fee Waiver (1 transfer)', source: 'AutoSave Bonus', status: 'redeemed', statusColor: '#10b981' }
    ],
    totalRewards: { cash: 500, points: 150 }
};

// â”€â”€â”€ CORE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(page) {
    if (page === 'goal') { initChat(); }
    state.page = page;
    render();
}
function login() { state.isAuth = true; nav('home'); }

function toast(msg, color) {
    var el = document.createElement('div');
    el.className = 'toast';
    el.style.borderLeftColor = color || '#10b981';
    el.innerHTML = '<p style="font-weight:500">' + msg + '</p>';
    document.body.appendChild(el);
    setTimeout(function() { el.parentNode && el.parentNode.removeChild(el); }, 2800);
}

function fmt(n) { return Number(n).toLocaleString('en-NG'); }

function completeStep(stepId) {
    var m = state.missions[0];
    var step = null;
    for (var i = 0; i < m.steps.length; i++) { if (m.steps[i].id === stepId) { step = m.steps[i]; break; } }
    if (step && !step.done) {
        step.done = true;
        m.progress++;
        toast('<i class="fas fa-check"></i> ' + step.text + ' completed!');
        if (m.progress === m.total) {
            setTimeout(function() {
                state.user.wallet.points += 250;
                state.totalRewards.points += 250;
                var r = null;
                for (var i = 0; i < state.rewards.length; i++) { if (state.rewards[i].source === 'Home Upgrade Sprint') { r = state.rewards[i]; break; } }
                if (r) { r.status = 'redeem'; r.statusColor = '#E41000'; }
                toast('<i class="fas fa-trophy"></i> Mission Complete! 250 Goal Points earned!', '#f59e0b');
                render();
            }, 1500);
        }
        render();
    }
}

// â”€â”€â”€ PLAN LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPlan(pk) {
    var g = state.goal || { budget: 200000, timeline: 8, monthlyMax: 25000 };
    var wkly = Math.round(g.budget / g.timeline / 1000) * 1000;
    var savTot = Math.round(g.budget * 0.4 / 1000) * 1000;
    var loanTot = g.budget - savTot;
    var wklySav = Math.round(savTot / g.timeline / 1000) * 1000;
    var loanMo = Math.round(loanTot / (Math.ceil(g.timeline / 4) * 2) / 100) * 100;
    var plans = {
        save_only:    { label: 'Save-Only Plan',    icon: 'fa-piggy-bank',    color: '#3b82f6', tag: null,          lines: ['Save &#8358;' + fmt(wkly) + '/week for ' + g.timeline + ' weeks', 'Total: &#8358;' + fmt(g.budget), 'No credit required'] },
        hybrid:       { label: 'Hybrid Plan',       icon: 'fa-balance-scale', color: '#f59e0b', tag: 'Recommended', lines: ['Save &#8358;' + fmt(wklySav) + '/week (&#8358;' + fmt(savTot) + ' total)', 'Pre-approved loan: &#8358;' + fmt(loanTot), 'Monthly repayment &le; &#8358;' + fmt(loanMo)] },
        credit_first: { label: 'Credit-First Plan', icon: 'fa-bolt',          color: '#10b981', tag: null,          lines: ['Take &#8358;' + fmt(g.budget) + ' now', 'Higher monthly repayment applies', 'Funds available immediately'] }
    };
    return plans[pk];
}

function selectPlan(planKey) {
    state.selectedPlan = planKey;
    nav('mission');
    toast('<i class="fas fa-rocket"></i> Plan activated! Your mission is ready.', '#10b981');
}

// â”€â”€â”€ CHAT ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Demo scenario scripts: each is an array of { userText, aiText, delay?, cards?, planCards?, actionBtn? }
var SCENARIOS = {
    furniture: [
        { userText: 'I want to buy furniture for my new apartment',
          aiDelay: 1400,
          aiText: 'Great choice! Furnishing a new space can really make it feel like home ğŸ \n\nWhat\'s your total budget for the furniture?',
          collecting: 'budget' },
        { userText: 'â‚¦350,000',
          aiDelay: 1200,
          aiText: 'Perfect. And what\'s your timeline â€” how many weeks would you like to achieve this in?',
          collecting: 'timeline' },
        { userText: '10 weeks',
          aiDelay: 1100,
          aiText: 'Got it. Last thing â€” what\'s the max you\'re comfortable paying per month?',
          collecting: 'monthlyMax' },
        { userText: 'â‚¦40,000/month',
          aiDelay: 1800,
          aiText: 'Analysing your goal...',
          isAnalysing: true },
        { aiDelay: 2200,
          aiText: 'Here are your 3 recommended paths for a â‚¦350,000 furniture goal in 10 weeks:',
          planCards: true,
          goal: { upgradeType: 'Furniture', budget: 350000, timeline: 10, preference: 'Hybrid', monthlyMax: 40000 } }
    ],
    renovation: [
        { userText: 'I need to renovate my kitchen and bathrooms',
          aiDelay: 1300,
          aiText: 'A kitchen and bathroom renovation â€” great investment! ğŸ”¨\n\nHow much do you estimate the full renovation will cost?',
          collecting: 'budget' },
        { userText: 'About â‚¦500,000',
          aiDelay: 1100,
          aiText: 'That\'s a solid budget. Over what period are you hoping to fund this â€” how many weeks?',
          collecting: 'timeline' },
        { userText: '12 weeks',
          aiDelay: 1000,
          aiText: 'And would you prefer to save gradually, use a pre-approved loan, or a mix of both?',
          cards: [
              { val: 'Save-only', icon: 'fa-piggy-bank', color: '#3b82f6', label: 'Save-only', sub: 'Build from savings alone' },
              { val: 'Hybrid', icon: 'fa-balance-scale', color: '#f59e0b', label: 'Hybrid', sub: 'Save part + pre-approved credit', tag: 'Popular' },
              { val: 'Credit-first', icon: 'fa-bolt', color: '#10b981', label: 'Credit-first', sub: 'Access funds now, repay over time' }
          ],
          collecting: 'preference' },
        { userText: 'Hybrid',
          aiDelay: 1800,
          aiText: 'Running the numbers...',
          isAnalysing: true },
        { aiDelay: 2400,
          aiText: 'Here are your 3 recommended paths for a â‚¦500,000 renovation in 12 weeks:',
          planCards: true,
          goal: { upgradeType: 'Repairs', budget: 500000, timeline: 12, preference: 'Hybrid', monthlyMax: 45000 } }
    ],
    appliances: [
        { userText: 'I want to buy new appliances â€” fridge, washing machine, TV',
          aiDelay: 1500,
          aiText: 'Nice upgrade! ğŸ“º A full appliance refresh usually runs between â‚¦150kâ€“â‚¦300k depending on brands.\n\nDo you have a specific budget in mind?',
          collecting: 'budget' },
        { userText: 'â‚¦200,000',
          aiDelay: 1000,
          aiText: 'Perfect. And since you already know what you need, would you like to get the money immediately through a pre-approved loan, or save up first?',
          cards: [
              { val: 'Save-only', icon: 'fa-piggy-bank', color: '#3b82f6', label: 'Save first', sub: '8â€“12 weeks to build up funds' },
              { val: 'Credit-first', icon: 'fa-bolt', color: '#10b981', label: 'Get funds now', sub: 'Pre-approved credit, repay monthly' },
              { val: 'Hybrid', icon: 'fa-balance-scale', color: '#f59e0b', label: 'Split it', sub: 'Half savings, half credit', tag: 'Recommended' }
          ],
          collecting: 'preference' },
        { userText: 'Get funds now',
          aiDelay: 1100,
          aiText: 'Smart choice for immediate needs. What\'s the most you can comfortably repay per month?',
          collecting: 'monthlyMax' },
        { userText: 'â‚¦25,000',
          aiDelay: 1800,
          aiText: 'Crunching your numbers...',
          isAnalysing: true },
        { aiDelay: 2200,
          aiText: 'Here are your 3 recommended paths for a â‚¦200,000 appliances goal:',
          planCards: true,
          goal: { upgradeType: 'Appliances', budget: 200000, timeline: 8, preference: 'Credit-first', monthlyMax: 25000 } }
    ]
};

function initChat() {
    state.chat.messages = [];
    state.chat.collecting = null;
    state.chat.isTyping = false;
    // Opening AI greeting
    state.chat.messages.push({
        role: 'ai',
        text: 'Hi Amina! ğŸ‘‹ I\'m AI-Money.\n\nTell me what you\'re saving or planning for and I\'ll build a personalised financial plan for you. You can type anything â€” or try one of the shortcuts below.'
    });
}

function addMessage(role, text, extras) {
    var msg = Object.assign({ role: role, text: text }, extras || {});
    state.chat.messages.push(msg);
}

function scrollChatToBottom() {
    setTimeout(function() {
        var el = document.getElementById('chat-messages');
        if (el) el.scrollTop = el.scrollHeight;
    }, 50);
}

function renderChatMessages() {
    return state.chat.messages.map(function(msg, idx) {
        var isAI = msg.role === 'ai';
        var avatarHtml = isAI
            ? '<div class="msg-avatar" style="background:rgba(228,0,43,0.15);border:1px solid rgba(228,0,43,0.3)"><i class="fas fa-robot" style="color:#E41000;font-size:0.65rem"></i></div>'
            : '';

        var bubbleText = msg.text ? msg.text.replace(/\n/g, '<br>') : '';
        var bubbleHtml = bubbleText
            ? '<div class="bubble ' + (isAI ? 'ai' : 'user') + '">' + bubbleText + '</div>'
            : '';

        // Preference cards inside a bubble
        var cardsHtml = '';
        if (msg.cards && msg.cards.length) {
            cardsHtml = '<div style="max-width:78%;margin-top:0.25rem">' +
                msg.cards.map(function(c) {
                    return '<div class="plan-card" style="margin-bottom:0.5rem" onclick="chatSelectOption(\'' + c.val + '\')">' +
                        '<div class="flex items-center gap-3">' +
                            '<div class="w-9 h-9 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(255,255,255,0.06)"><i class="fas ' + c.icon + '" style="color:' + c.color + '"></i></div>' +
                            '<div><div class="flex items-center gap-2"><p class="font-semibold text-sm">' + c.label + '</p>' + (c.tag ? '<span class="badge badge-warning" style="font-size:0.6rem;padding:0.1rem 0.4rem">' + c.tag + '</span>' : '') + '</div>' +
                            '<p class="text-gray-400 text-xs">' + c.sub + '</p></div>' +
                        '</div>' +
                    '</div>';
                }).join('') +
            '</div>';
        }

        // Plan recommendation cards
        var planCardsHtml = '';
        if (msg.planCards) {
            var planKeys = ['save_only', 'hybrid', 'credit_first'];
            planCardsHtml = '<div style="max-width:88%;margin-top:0.25rem">' +
                planKeys.map(function(pk) {
                    var p = getPlan(pk);
                    var isSel = state.selectedPlan === pk;
                    var linesHtml = p.lines.map(function(l) {
                        return '<li class="text-xs text-gray-300 flex items-start gap-1.5"><span style="color:#10b981">â€º</span>' + l + '</li>';
                    }).join('');
                    return '<div class="plan-card' + (pk === 'hybrid' ? ' recommended' : '') + (isSel ? ' selected' : '') + '" onclick="chatPickPlan(\'' + pk + '\')" style="margin-bottom:0.5rem">' +
                        '<div class="flex items-start justify-between mb-2">' +
                            '<div class="flex items-center gap-2">' +
                                '<div class="w-8 h-8 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(255,255,255,0.05)"><i class="fas ' + p.icon + '" style="color:' + p.color + ';font-size:0.8rem"></i></div>' +
                                '<p class="font-semibold text-sm">' + p.label + '</p>' +
                            '</div>' +
                            (p.tag ? '<span class="badge badge-warning" style="font-size:0.6rem;padding:0.1rem 0.4rem">' + p.tag + '</span>' : '') +
                            (isSel ? '<div class="w-5 h-5 rounded-full flex items-center justify-center" style="background:#10b981"><i class="fas fa-check" style="font-size:0.6rem;color:white"></i></div>' : '') +
                        '</div>' +
                        '<ul class="space-y-0.5">' + linesHtml + '</ul>' +
                    '</div>';
                }).join('') +
                '<button onclick="activateSelectedPlan()" class="btn btn-primary w-full justify-center text-sm mt-1"' + (state.selectedPlan ? '' : ' style="background:#333;color:#888;cursor:not-allowed"') + '>Activate This Plan &#8594;</button>' +
            '</div>';
        }

        return '<div class="msg-row ' + (isAI ? '' : 'user') + '">' +
            avatarHtml +
            '<div style="display:flex;flex-direction:column;gap:0.3rem;' + (isAI ? '' : 'align-items:flex-end') + '">' +
                bubbleHtml +
                cardsHtml +
                planCardsHtml +
            '</div>' +
        '</div>';
    }).join('');
}

function showTyping() {
    var el = document.getElementById('chat-messages');
    if (!el) return;
    var row = document.createElement('div');
    row.id = 'typing-indicator';
    row.className = 'msg-row';
    row.innerHTML =
        '<div class="msg-avatar" style="background:rgba(228,0,43,0.15);border:1px solid rgba(228,0,43,0.3)"><i class="fas fa-robot" style="color:#E41000;font-size:0.65rem"></i></div>' +
        '<div class="typing-bubble"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';
    el.appendChild(row);
    el.scrollTop = el.scrollHeight;
}

function hideTyping() {
    var el = document.getElementById('typing-indicator');
    if (el) el.parentNode.removeChild(el);
}

// Re-render just the chat messages area without full page re-render (avoids input losing focus)
function patchChatMessages() {
    var el = document.getElementById('chat-messages');
    if (!el) { render(); return; }
    el.innerHTML = renderChatMessages();
    el.scrollTop = el.scrollHeight;
}

// Select a preference card option inside chat
function chatSelectOption(val) {
    if (state.chat.collecting !== 'preference') return;
    state.chat.collecting = null;
    addMessage('user', val);
    patchChatMessages();
    // Continue scenario
    continueActiveScenario(val);
}

function chatPickPlan(pk) {
    state.selectedPlan = pk;
    patchChatMessages();
    scrollChatToBottom();
}

function activateSelectedPlan() {
    if (!state.selectedPlan) {
        toast('<i class="fas fa-exclamation-circle"></i> Please select a plan first', '#E41000');
        return;
    }
    var s1 = state.missions[0].steps[0];
    if (!s1.done) { s1.done = true; state.missions[0].progress = 1; }
    selectPlan(state.selectedPlan);
}

// â”€â”€â”€ SCENARIO RUNNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var _activeScenario = null;
var _scenarioStep = 0;
var _waitingForInput = false;   // true = we already emitted user message, now emit ai reply
var _pendingUserText = null;

function runScenario(key) {
    _activeScenario = SCENARIOS[key];
    _scenarioStep = 0;
    _waitingForInput = false;
    _pendingUserText = null;
    state.chat.collecting = null;
    _runNextScenarioStep();
}

function _runNextScenarioStep() {
    if (!_activeScenario || _scenarioStep >= _activeScenario.length) return;
    var step = _activeScenario[_scenarioStep];
    _scenarioStep++;

    // If step has a userText, show it (simulates the user typing)
    if (step.userText) {
        addMessage('user', step.userText);
        patchChatMessages();
        _pendingUserText = step.userText;
    }

    // Then after a delay show AI response
    if (step.aiText || step.planCards) {
        var delay = step.aiDelay || 1200;
        setTimeout(function() {
            hideTyping();

            if (step.isAnalysing) {
                // Show the analysing bubble, then immediately continue to next step
                addMessage('ai', step.aiText);
                patchChatMessages();
                // show typing again briefly before next step
                setTimeout(function() { showTyping(); }, 300);
                _runNextScenarioStep();
                return;
            }

            // Set goal state if provided
            if (step.goal) {
                state.goal = step.goal;
            }

            var extras = {};
            if (step.cards) extras.cards = step.cards;
            if (step.planCards) extras.planCards = true;
            if (step.collecting) {
                state.chat.collecting = step.collecting;
                extras.collecting = step.collecting;
            }

            addMessage('ai', step.aiText || '', extras);
            patchChatMessages();

            // If this step doesn't wait for user input, auto-continue
            if (!step.collecting && !step.planCards && _scenarioStep < _activeScenario.length) {
                setTimeout(function() {
                    showTyping();
                    _runNextScenarioStep();
                }, 600);
            }
        }, delay);
        showTyping();
    }
}

// Called when user taps a card option mid-scenario
function continueActiveScenario(userVal) {
    if (!_activeScenario) return;
    // The user just replied â€” run the next AI step
    var delay = 1000;
    setTimeout(function() {
        showTyping();
        _runNextScenarioStep();
    }, 300);
}

// â”€â”€â”€ FREE-FORM INPUT HANDLER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function chatSend(text) {
    text = (text || '').trim();
    if (!text) return;

    // Clear input
    var inp = document.getElementById('chat-input');
    if (inp) inp.value = '';

    addMessage('user', text);
    patchChatMessages();

    var lower = text.toLowerCase();
    var collecting = state.chat.collecting;

    if (collecting === 'preference') {
        // User typed a preference instead of tapping card
        state.chat.collecting = null;
        continueActiveScenario(text);
        return;
    }

    if (collecting) {
        // User typed a value for budget / timeline / monthlyMax
        state.chat.collecting = null;
        continueActiveScenario(text);
        return;
    }

    // No active scenario â€” parse intent and start one
    if (lower.includes('furniture') || lower.includes('chair') || lower.includes('sofa') || lower.includes('table')) {
        setTimeout(function() { showTyping(); runScenario('furniture'); }, 300);
        return;
    }
    if (lower.includes('renovat') || lower.includes('kitchen') || lower.includes('bathroom') || lower.includes('repair') || lower.includes('paint') || lower.includes('floor')) {
        setTimeout(function() { showTyping(); runScenario('renovation'); }, 300);
        return;
    }
    if (lower.includes('appliance') || lower.includes('fridge') || lower.includes('washing') || lower.includes('tv') || lower.includes('microwave')) {
        setTimeout(function() { showTyping(); runScenario('appliances'); }, 300);
        return;
    }

    // Generic fallback â€” ask clarifying question
    var delay = 1100;
    showTyping();
    setTimeout(function() {
        hideTyping();
        addMessage('ai', 'Got it! To build your plan, could you tell me a bit more?\n\nâ€¢ What exactly are you saving or planning for?\nâ€¢ What\'s your rough budget?\nâ€¢ How soon do you need it?\n\nFeel free to answer all at once!');
        state.chat.collecting = 'goal_description';
        patchChatMessages();
    }, delay);
}

function chatSendFromInput() {
    var inp = document.getElementById('chat-input');
    if (inp) chatSend(inp.value);
}

function chatInputKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatSendFromInput();
    }
}

// â”€â”€â”€ RENDERERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderWelcome() {
    return '<div class="min-h-screen relative flex items-center justify-center p-6" style="background-image:url(\'welcome-background-with-logo.jpg\');background-size:cover;background-position:center;">' +
        '<div class="relative z-10 max-w-md w-full text-center">' +
            '<p class="text-xl font-semibold text-white mb-3">Turn money into momentum</p>' +
            '<p class="text-base text-gray-300 mb-12">Achieve goals. Unlock rewards. Live freer.</p>' +
            '<div class="space-y-4">' +
                '<button onclick="login()" class="w-full py-4 px-6 rounded-xl font-medium flex items-center justify-center gap-3 transition-all active:scale-95" style="background:#000;color:white;">' +
                    '<i class="fab fa-whatsapp" style="font-size:1.25rem"></i> Continue with WhatsApp' +
                '</button>' +
                '<button onclick="login()" class="w-full py-4 px-6 rounded-xl font-medium flex items-center justify-center gap-3 transition-all active:scale-95" style="background:#E41000;color:white;">' +
                    '<i class="fas fa-mobile-alt" style="font-size:1.25rem"></i> Continue with Phone Number' +
                '</button>' +
            '</div>' +
        '</div>' +
    '</div>';
}

function renderHome() {
    var m = state.missions[0];
    var pct = (m.progress / m.total) * 100;
    var rewardsHtml = state.rewards.map(function(r) {
        return '<div class="rounded-xl p-3" style="background:#1a1a1a">' +
            '<div class="flex items-center justify-between mb-1">' +
                '<h3 class="font-semibold text-sm">' + r.amount + '</h3>' +
                '<span class="text-xs px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.1);color:' + r.statusColor + ';text-transform:capitalize">' + r.status + '</span>' +
            '</div>' +
            '<p class="text-gray-400 text-xs">From: ' + r.source + '</p>' +
        '</div>';
    }).join('');

    return '<div class="min-h-screen pb-28" style="background:#0a0a0a">' +
        '<div class="px-6 py-4" style="background:#1a1a1a">' +
            '<div class="flex items-center justify-between">' +
                '<div>' +
                    '<h1 class="text-2xl font-bold mb-1">Hi, Amina <i class="fas fa-hand-paper" style="color:#f59e0b"></i></h1>' +
                    '<p class="text-gray-400 text-sm">' + state.user.phone + '</p>' +
                '</div>' +
                '<img src="amina-profile.png" alt="Amina" class="w-12 h-12 rounded-full object-cover" style="cursor:pointer" onclick="nav(\'profile\')">' +
            '</div>' +
        '</div>' +
        '<div class="px-6 space-y-5 mt-5">' +
            '<div class="flex justify-between gap-3">' +
                '<div class="flex flex-col items-center gap-2 cursor-pointer">' +
                    '<div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background:#E41000"><i class="fas fa-credit-card" style="color:white;font-size:1.5rem"></i></div>' +
                    '<span class="text-xs font-medium">Payments</span>' +
                '</div>' +
                '<div class="flex flex-col items-center gap-2 cursor-pointer" onclick="nav(\'goal\')">' +
                    '<div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background:#E41000"><i class="fas fa-bullseye" style="color:white;font-size:1.5rem"></i></div>' +
                    '<span class="text-xs font-medium">Goals</span>' +
                '</div>' +
                '<div class="flex flex-col items-center gap-2 cursor-pointer" onclick="nav(\'mission\')">' +
                    '<div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background:#E41000"><i class="fas fa-coins" style="color:white;font-size:1.5rem"></i></div>' +
                    '<span class="text-xs font-medium">Earn</span>' +
                '</div>' +
                '<div class="flex flex-col items-center gap-2 cursor-pointer">' +
                    '<div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background:#E41000"><i class="fas fa-exchange-alt" style="color:white;font-size:1.5rem"></i></div>' +
                    '<span class="text-xs font-medium">Transfer</span>' +
                '</div>' +
            '</div>' +
            '<div class="card-static" style="border:1px solid rgba(245,158,11,0.25)">' +
                '<div class="flex items-center justify-between">' +
                    '<div>' +
                        '<p class="text-gray-400 text-xs mb-1">Goal Points Balance</p>' +
                        '<p class="text-2xl font-bold" style="color:#f59e0b">' + state.user.wallet.points.toLocaleString() + ' <span class="text-sm font-medium">pts</span></p>' +
                    '</div>' +
                    '<div class="w-12 h-12 rounded-2xl flex items-center justify-center" style="background:rgba(245,158,11,0.15)"><i class="fas fa-star" style="color:#f59e0b;font-size:1.25rem"></i></div>' +
                '</div>' +
            '</div>' +
            '<div class="card" style="background:linear-gradient(90deg,rgba(245,158,11,0.2),rgba(249,115,22,0.2));border:1px solid rgba(245,158,11,0.3)">' +
                '<div class="flex items-center gap-4">' +
                    '<div class="text-4xl"><i class="fas fa-gift" style="color:#f59e0b"></i></div>' +
                    '<div><h3 class="font-semibold mb-1">Mystery Box</h3><p class="text-gray-400 text-sm">Complete 3 goals to unlock</p></div>' +
                '</div>' +
            '</div>' +
            '<div class="card-static">' +
                '<div class="flex items-center justify-between mb-4">' +
                    '<h2 class="text-lg font-semibold">Your Rewards</h2>' +
                    '<span class="text-xs" style="color:#10b981">&#8358;' + fmt(state.totalRewards.cash) + ' + ' + state.totalRewards.points + ' pts</span>' +
                '</div>' +
                '<div class="space-y-3">' + rewardsHtml + '</div>' +
            '</div>' +
            '<div class="card-static" style="background:linear-gradient(135deg,#212121,#1a1a1a);border:1px solid rgba(16,185,129,0.2)">' +
                '<div class="mb-3">' +
                    '<div class="badge badge-warning mb-2">Active Mission</div>' +
                    '<h3 class="font-semibold mb-1">' + m.name + '</h3>' +
                    '<p class="text-gray-400 text-sm">' + m.desc + ' <span style="color:#f59e0b">&#8594; ' + m.reward + '</span></p>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<div class="flex items-center justify-between text-sm mb-2"><span class="text-gray-400">Progress</span><span class="font-medium">' + m.progress + '/' + m.total + ' steps</span></div>' +
                    '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>' +
                '</div>' +
                '<button onclick="nav(\'mission\')" class="btn btn-primary w-full justify-center">Continue &#8594;</button>' +
            '</div>' +
        '</div>' +
        '<div class="fixed bottom-6 left-6 right-6 z-30">' +
            '<button onclick="nav(\'goal\')" class="w-full py-4 px-6 rounded-full font-semibold flex items-center justify-center gap-3 transition-all active:scale-95 shadow-lg" style="background:#E41000;color:white;">' +
                '<i class="fas fa-robot" style="font-size:1.25rem"></i> Chat to AI-Money' +
            '</button>' +
        '</div>' +
    '</div>';
}

// â”€â”€â”€ CHAT / GOAL SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGoal() {
    var shortcuts = [
        { icon: 'fa-couch',       label: 'Furnish apartment',    key: 'furniture' },
        { icon: 'fa-tools',       label: 'Renovate kitchen',     key: 'renovation' },
        { icon: 'fa-blender',     label: 'Buy appliances',       key: 'appliances' }
    ];

    var shortcutsHtml = shortcuts.map(function(s) {
        return '<button class="shortcut-btn" onclick="runScenario(\'' + s.key + '\')">' +
            '<i class="fas ' + s.icon + '"></i>' + s.label +
        '</button>';
    }).join('');

    return '<div class="chat-wrap">' +
        // Header
        '<div class="chat-header">' +
            '<button onclick="nav(\'home\')" style="background:none;border:none;color:#aaa;font-size:1.3rem;cursor:pointer;padding:0.2rem 0.4rem;margin-left:-0.25rem">&#8592;</button>' +
            '<div class="w-9 h-9 rounded-full flex items-center justify-center flex-shrink-0" style="background:rgba(228,0,43,0.18);border:1.5px solid rgba(228,0,43,0.35)"><i class="fas fa-robot" style="color:#E41000;font-size:0.9rem"></i></div>' +
            '<div>' +
                '<p class="text-sm font-bold leading-tight">AI-Money</p>' +
                '<p class="text-xs" style="color:#10b981">â— Goal Creation</p>' +
            '</div>' +
        '</div>' +
        // Messages
        '<div id="chat-messages" class="chat-messages">' +
            renderChatMessages() +
        '</div>' +
        // Input area
        '<div class="chat-input-area">' +
            '<div class="shortcuts-row" id="shortcuts-row">' +
                '<span class="text-xs font-medium flex-shrink-0" style="color:#555;align-self:center;margin-right:0.25rem"><i class="fas fa-magic" style="font-size:0.65rem;margin-right:0.2rem"></i>Try:</span>' +
                shortcutsHtml +
            '</div>' +
            '<div class="chat-input-row">' +
                '<textarea id="chat-input" placeholder="Tell me what you\'re planningâ€¦" rows="1" onkeydown="chatInputKeydown(event)" oninput="this.style.height=\'auto\';this.style.height=this.scrollHeight+\'px\'"></textarea>' +
                '<button class="send-btn" onclick="chatSendFromInput()">' +
                    '<i class="fas fa-paper-plane" style="color:white;font-size:0.8rem"></i>' +
                '</button>' +
            '</div>' +
        '</div>' +
    '</div>';
}

function renderMission() {
    var m = state.missions[0];
    var pct = (m.progress / m.total) * 100;
    var plan = state.selectedPlan ? getPlan(state.selectedPlan) : null;
    var goal = state.goal;

    var planSummary = '';
    if (plan && goal) {
        planSummary = '<div class="card-static mb-4" style="background:#1a1a1a;border:1px solid rgba(16,185,129,0.3)">' +
            '<div class="flex items-center justify-between mb-3">' +
                '<div class="flex items-center gap-2"><i class="fas ' + plan.icon + '" style="color:' + plan.color + '"></i><span class="font-semibold text-sm">' + plan.label + '</span></div>' +
                (plan.tag ? '<span class="badge badge-warning" style="font-size:0.65rem">' + plan.tag + '</span>' : '') +
            '</div>' +
            '<div class="grid grid-cols-2 gap-2 text-xs">' +
                '<div class="rounded-lg p-2" style="background:#212121"><p class="text-gray-400 mb-0.5">Target</p><p class="font-bold">&#8358;' + fmt(goal.budget) + '</p></div>' +
                '<div class="rounded-lg p-2" style="background:#212121"><p class="text-gray-400 mb-0.5">Timeline</p><p class="font-bold">' + goal.timeline + ' weeks</p></div>' +
                '<div class="rounded-lg p-2" style="background:#212121"><p class="text-gray-400 mb-0.5">Monthly cap</p><p class="font-bold">&#8358;' + fmt(goal.monthlyMax) + '</p></div>' +
                '<div class="rounded-lg p-2" style="background:#212121"><p class="text-gray-400 mb-0.5">Upgrading</p><p class="font-bold">' + goal.upgradeType + '</p></div>' +
            '</div>' +
        '</div>';
    }

    var stepsHtml = m.steps.map(function(s, i) {
        return '<div class="card-static" style="' + (s.done ? 'background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.3)' : 'background:#212121;border:1px solid #2a2a2a') + '">' +
            '<div class="flex items-start gap-4">' +
                '<div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0" style="background:' + (s.done ? '#10b981' : '#1a1a1a') + ';color:' + (s.done ? 'white' : '#666') + '">' +
                    (s.done ? '<i class="fas fa-check" style="font-size:0.85rem"></i>' : (i + 1)) +
                '</div>' +
                '<div class="flex-1">' +
                    '<p class="font-medium mb-2' + (s.done ? ' line-through' : '') + '" style="color:' + (s.done ? '#10b981' : 'white') + '">' + s.text + '</p>' +
                    (s.done
                        ? '<p class="text-sm" style="color:#10b981"><i class="fas fa-check-circle"></i> Completed</p>'
                        : '<button onclick="completeStep(\'' + s.id + '\')" class="btn btn-primary text-sm">Complete Step</button>') +
                '</div>' +
            '</div>' +
        '</div>';
    }).join('');

    var nextIncomplete = null;
    for (var i = 0; i < m.steps.length; i++) { if (!m.steps[i].done) { nextIncomplete = m.steps[i]; break; } }

    var bottomAction = m.progress < m.total
        ? '<div><button onclick="completeStep(\'' + nextIncomplete.id + '\')" class="w-full btn btn-primary justify-center"><i class="fas fa-arrow-right"></i> Complete Next Step</button><p class="text-center text-xs mt-2" style="color:#555">Demo: tap to simulate step completion</p></div>'
        : '<div class="card-static text-center" style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3)"><i class="fas fa-trophy text-4xl mb-3" style="color:#f59e0b"></i><h3 class="text-lg font-bold mb-1">Mission Complete!</h3><p class="text-gray-400 text-sm">You earned <span class="font-bold" style="color:#10b981">250 Goal Points</span></p></div>';

    return '<div class="min-h-screen pb-6" style="background:#0a0a0a">' +
        '<div class="px-6 py-4" style="background:#1a1a1a">' +
            '<div class="flex items-center gap-4"><button onclick="nav(\'home\')" class="text-2xl">&#8592;</button><h1 class="text-xl font-bold">Mission Details</h1></div>' +
        '</div>' +
        '<div class="px-6 py-5 space-y-4">' +
            planSummary +
            '<div class="card-static">' +
                '<div class="flex items-start gap-4 mb-4">' +
                    '<div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background:rgba(245,158,11,0.15)"><i class="fas fa-home" style="color:#f59e0b;font-size:1.5rem"></i></div>' +
                    '<div class="flex-1">' +
                        '<h2 class="text-xl font-bold mb-1">' + m.name + '</h2>' +
                        '<p class="text-gray-400 text-sm mb-3">' + m.desc + '</p>' +
                        '<div class="badge badge-warning">8 weeks remaining</div>' +
                    '</div>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<div class="flex items-center justify-between text-sm mb-2"><span class="text-gray-400">Progress</span><span class="font-medium">' + m.progress + '/' + m.total + ' completed</span></div>' +
                    '<div class="progress-bar" style="height:0.625rem"><div class="progress-fill" style="width:' + pct + '%"></div></div>' +
                '</div>' +
                '<div class="p-3 rounded-xl flex items-center gap-3" style="background:linear-gradient(90deg,rgba(245,158,11,0.2),rgba(249,115,22,0.2));border:1px solid rgba(245,158,11,0.3)">' +
                    '<i class="fas fa-star" style="color:#f59e0b;font-size:1.2rem"></i>' +
                    '<div><p class="text-gray-400 text-xs">Reward</p><p class="font-bold" style="color:#f59e0b">' + m.reward + '</p></div>' +
                '</div>' +
            '</div>' +
            '<div><h3 class="text-base font-semibold mb-3">Steps to Complete</h3><div class="space-y-3">' + stepsHtml + '</div></div>' +
            bottomAction +
        '</div>' +
    '</div>';
}

function renderProfile() {
    var goalSection = '';
    if (state.goal) {
        goalSection = '<div class="card-static" style="background:#212121;border:1px solid rgba(16,185,129,0.2)">' +
            '<h3 class="text-base font-semibold mb-3 flex items-center gap-2"><i class="fas fa-bullseye" style="color:#10b981"></i> Active Goal</h3>' +
            '<div class="space-y-2 text-sm">' +
                '<div class="flex justify-between"><span class="text-gray-400">Goal</span><span class="font-medium">Home Upgrade (' + state.goal.upgradeType + ')</span></div>' +
                '<div class="flex justify-between"><span class="text-gray-400">Target</span><span class="font-medium">&#8358;' + fmt(state.goal.budget) + '</span></div>' +
                '<div class="flex justify-between"><span class="text-gray-400">Plan</span><span class="font-medium">' + (state.selectedPlan ? getPlan(state.selectedPlan).label : 'Pending') + '</span></div>' +
            '</div>' +
        '</div>';
    }
    var badgesHtml = state.user.badges.map(function(b) {
        return '<div class="rounded-xl px-4 py-3 flex items-center justify-between mb-2" style="background:#1a1a1a"><span class="font-medium text-sm">' + b + '</span><div class="badge badge-success">Active</div></div>';
    }).join('');

    return '<div class="min-h-screen pb-6" style="background:#0a0a0a">' +
        '<div class="px-6 py-4" style="background:#1a1a1a">' +
            '<div class="flex items-center gap-4 mb-5"><button onclick="nav(\'home\')" class="text-2xl">&#8592;</button><h1 class="text-xl font-bold">Identity</h1></div>' +
            '<div class="flex items-center gap-4">' +
                '<img src="amina-profile.png" alt="Amina" class="w-16 h-16 rounded-full object-cover">' +
                '<div><h2 class="text-xl font-bold">' + state.user.name + '</h2><p class="text-gray-400 text-sm">' + state.user.phone + '</p></div>' +
            '</div>' +
        '</div>' +
        '<div class="px-6 py-6 space-y-5">' +
            '<div class="card-static" style="background:#212121">' +
                '<h3 class="text-base font-semibold mb-4">Basic Information</h3>' +
                '<div class="space-y-4">' +
                    '<div><label class="text-gray-400 text-xs mb-1 block">Username</label><p class="font-medium">aminad</p></div>' +
                    '<div><label class="text-gray-400 text-xs mb-1 block">Email</label><p class="font-medium">' + state.user.email + '</p></div>' +
                    '<div class="flex gap-4">' +
                        '<div><label class="text-gray-400 text-xs mb-1 block">Cash Balance</label><div class="rounded-xl px-4 py-2 inline-block" style="background:#1a1a1a"><p class="font-bold">&#8358;' + state.user.wallet.cash.toLocaleString() + '</p></div></div>' +
                        '<div><label class="text-gray-400 text-xs mb-1 block">Goal Points</label><div class="rounded-xl px-4 py-2 inline-block" style="background:#1a1a1a;border:1px solid rgba(245,158,11,0.3)"><p class="font-bold" style="color:#f59e0b">' + state.user.wallet.points.toLocaleString() + ' pts</p></div></div>' +
                    '</div>' +
                '</div>' +
            '</div>' +
            '<div class="card-static" style="background:#212121">' +
                '<h3 class="text-base font-semibold mb-4 flex items-center gap-2"><i class="fas fa-trophy" style="color:#f59e0b"></i> Badges &amp; Achievements</h3>' +
                badgesHtml +
            '</div>' +
            goalSection +
        '</div>' +
    '</div>';
}

function renderCampaigns() {
    var m = state.missions[0];
    var pct = (m.progress / m.total) * 100;
    var goal = state.goal;
    var plan = state.selectedPlan ? getPlan(state.selectedPlan) : null;

    var goalSection = goal
        ? '<div><h2 class="text-base font-semibold mb-3 flex items-center gap-2"><i class="fas fa-home" style="color:#10b981"></i> Active Goal</h2>' +
            '<div class="card-static" style="background:#1a1a1a;border:1px solid rgba(16,185,129,0.25)">' +
                '<div class="flex items-start justify-between mb-3">' +
                    '<div><p class="font-semibold">Home Upgrade Sprint</p><p class="text-gray-400 text-xs">' + goal.upgradeType + ' Â· &#8358;' + fmt(goal.budget) + ' Â· ' + goal.timeline + ' weeks</p></div>' +
                    '<span class="badge badge-warning" style="font-size:0.65rem">In Progress</span>' +
                '</div>' +
                (plan ? '<div class="flex items-center gap-2 mb-3 text-xs"><i class="fas ' + plan.icon + '" style="color:' + plan.color + '"></i><span class="text-gray-400">Plan:</span><span class="font-medium">' + plan.label + '</span></div>' : '') +
                '<div class="mb-1 flex justify-between text-xs text-gray-400"><span>Mission progress</span><span>' + m.progress + '/' + m.total + ' steps</span></div>' +
                '<div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div>' +
                '<button onclick="nav(\'mission\')" class="btn btn-primary w-full justify-center mt-4 text-sm">View Mission &#8594;</button>' +
            '</div></div>'
        : '<div><h2 class="text-base font-semibold mb-3 flex items-center gap-2"><i class="fas fa-home" style="color:#10b981"></i> Active Goal</h2>' +
            '<div class="card-static text-center" style="background:#1a1a1a;border:1px dashed #333">' +
                '<i class="fas fa-bullseye text-3xl mb-3" style="color:#555"></i><p class="font-medium mb-1">No active goal yet</p>' +
                '<p class="text-gray-400 text-sm mb-4">Start a goal with AI-Money to see your plan here</p>' +
                '<button onclick="nav(\'goal\')" class="btn btn-primary justify-center"><i class="fas fa-robot"></i> Chat to AI-Money</button>' +
            '</div></div>';

    var recentRewards = state.rewards.map(function(r) {
        return '<div class="card-static mb-2" style="background:#1a1a1a">' +
            '<div class="flex items-center justify-between">' +
                '<div><h3 class="font-medium text-sm mb-0.5">' + r.amount + '</h3><p class="text-gray-400 text-xs">From: ' + r.source + '</p></div>' +
                '<span class="text-xs px-2 py-1 rounded-full" style="background:rgba(255,255,255,0.1);color:' + r.statusColor + ';text-transform:capitalize">' + r.status + '</span>' +
            '</div></div>';
    }).join('');

    return '<div class="min-h-screen pb-6" style="background:#0a0a0a">' +
        '<div class="px-6 py-6" style="background:#1a1a1a">' +
            '<h1 class="text-2xl font-bold mb-1">Campaigns</h1><p class="text-gray-400 text-sm">Your goals, missions &amp; rewards</p>' +
        '</div>' +
        '<div class="px-6 py-6 space-y-6">' +
            goalSection +
            '<div><h2 class="text-base font-semibold mb-3 flex items-center gap-2"><i class="fas fa-rocket" style="color:#f59e0b"></i> Active Mission</h2>' +
                '<div class="card" onclick="nav(\'mission\')" style="border:1px solid rgba(16,185,129,0.2)">' +
                    '<h3 class="font-semibold mb-1">' + m.name + '</h3><p class="text-gray-400 text-sm mb-3">' + m.desc + '</p>' +
                    '<div class="mb-3"><div class="flex justify-between text-xs text-gray-400 mb-2"><span>Progress</span><span>' + m.progress + '/' + m.total + '</span></div><div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%"></div></div></div>' +
                    '<div class="rounded-xl px-3 py-2 flex items-center justify-between" style="background:rgba(245,158,11,0.1)"><span class="text-sm font-medium" style="color:#f59e0b">' + m.reward + '</span><span style="color:#f59e0b">&#8594;</span></div>' +
                '</div>' +
            '</div>' +
            '<div><h2 class="text-base font-semibold mb-3 flex items-center gap-2"><i class="fas fa-gift" style="color:#f59e0b"></i> Recent Rewards</h2>' + recentRewards + '</div>' +
        '</div>' +
    '</div>';
}

// â”€â”€â”€ MASTER RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    var el = document.getElementById('app');
    if (!state.isAuth) { el.innerHTML = renderWelcome(); return; }
    if (state.page === 'home')      { el.innerHTML = renderHome();      return; }
    if (state.page === 'goal')      { el.innerHTML = renderGoal();      scrollChatToBottom(); return; }
    if (state.page === 'mission')   { el.innerHTML = renderMission();   return; }
    if (state.page === 'profile')   { el.innerHTML = renderProfile();   return; }
    if (state.page === 'campaigns') { el.innerHTML = renderCampaigns(); return; }
    el.innerHTML = renderHome();
}

render();
</script>
</body>
</html>
